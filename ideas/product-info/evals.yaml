matrix:
  assistant-id: asst_i27tBJfHmVb9sveuN9Lw9kR1
  output-average-eval-score-file: average-eval-score.json

  output-question-answer-file: output-${{ matrix.__matrix_id__ }}-answer.json
  output-question-answer-eval-file: output-${{ matrix.__matrix_id__ }}-eval-score.json
  output-question-answer-eval-file-pattern: output-*-eval-score.json

  output-chat-history-question-answer-file: output-question-answer-chat-history-${{ matrix.__matrix_id__ }}.jsonl
  output-chat-history-question-answer-eval-file: output-question-answer-eval-score-chat-history-${{ matrix.__matrix_id__ }}.jsonl

tests:
- area: matrix eval questions
  matrix-file: eval-questions.yaml

  steps:
  - name: Predict the answer w/ `ai chat`
    command: ai chat
    arguments:
      assistant-id: ${{ matrix.assistant-id }}
      question: ${{ matrix.question }}
      output-answer: ${{ matrix.output-question-answer-file }}
      output-chat-history: ${{ matrix.output-chat-history-question-answer-file }}

  - name: Check the answer against the truth
    command: ai chat
    arguments:
      assistant-id: '@none'
      system-prompt: You are a helpful assistant.
      question: '@eval-answer-prompt.md'
      var-question: ${{ matrix.question }}
      var-truth: ${{ matrix.truth }}
      var-answer: '{@${{ matrix.output-question-answer-file }}}'
      output-answer: ${{ matrix.output-question-answer-eval-file }}
      output-chat-history: ${{ matrix.output-chat-history-question-answer-eval-file }}

- area: post-evals
  steps:
  - name: Post-evaluation
    command: ai chat --built-in-functions
    arguments:
      assistant-id: '@none'
      system-prompt: You are a helpful assistant.
      question: '{@eval-average-prompt.md}'
      var-pattern: ${{ matrix.output-question-answer-eval-file-pattern }}
      output-answer: ${{ matrix.output-average-eval-score-file }}
