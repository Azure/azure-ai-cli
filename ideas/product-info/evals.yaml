matrix:
  assistant-id: asst_i27tBJfHmVb9sveuN9Lw9kR1
  predict-answer-output-chat-history-file: chat-answer-chat-history-${{ matrix.__matrix_id__ }}.jsonl
  predict-answer-output-answer-file: chat-answer-${{ matrix.__matrix_id__ }}.json
  eval-answer-output-chat-history-file: chat-eval-answer-chat-history-${{ matrix.__matrix_id__ }}.jsonl
  eval-answer-output-answer-file: chat-eval-answer-${{ matrix.__matrix_id__ }}.json
  eval-answer-output-answer-file-pattern: chat-eval-answer-*.json
  eval-answer-average-answer-file: chat-eval-average.json
  eval-answer-prompt: |
    Your task involves assessing the performance of an AI system based on a user's query, the AI's response, and the target answer, which we consider as an ideal response.
    
    Inputs:
    * A question or statement posed by a user.
    * An response generated by an AI.
    * A target answer, which represents a perfect score (10 out of 10) on our grading scale.

    Your task is to evaluate how closely the AI's answer aligns with the target answer using a grading scale of 1 to 10.
    * Consider clarity, relevancy, accuracy, completeness, and eloquence
    * 1 represents a poor response
    * 10 signifies a perfect response

    Ask yourself:
    * How accurate and relevant is the AIâ€™s answer in relation to the question/statement?
    * Is the AI's response as complete and informative as the target answer?
    * Is the AI's answer presented as clearly and eloquently as the target answer?

    Each of these aspects is equally important, and a perfect score would suggest that the AI has matched the target answer in all respects.

    Please remain unbiased and objective during your evaluation, approaching each assessment as if you have no prior experience or knowledge about the AI system. Your role is to act as an observer, not a participant.

    If the question is "Q", the target answer is "T", the AI answer is "A", and your score is "X", the output should look like:
    
      { "question": "Q", "target": "T", "prediction": "A", "score": X }

    Rules:
    1. Only output a single JSON object
    2. It must start with the '{' character
    3. It must end with the '}' character
    4. Do not include any other characters, such as newline characters
    5. The JSON object must contain the following keys: "question", "truth", and "score"
    6. The "question" and "truth" values must be strings
    7. The "score" value must be a number between 1 and 10
    
    ---

    Question: "${{ matrix.question }}"
    Target: "${{ matrix.truth }}"
    AI: "{@chat-answer-${{ matrix.__matrix_id__ }}.json}"
  eval-answer-average-answer-prompt: |
    Find on disk evaluations in files with this pattern: `${{ matrix.eval-answer-output-answer-file-pattern }}`
    
    Calculate the average score across all evaluations.

    Only output a floating point number, the average score, with up to two decimal places.

tests:
- area: matrix evals
  matrix:
    foreach:
    - question: "Which tent is the most waterproof?"
      truth: "The Alpine Explorer Tent has the highest rainfly waterproof rating at 3000m"
    - question: "Which camping table holds the most weight?"
      truth: "The Adventure Dining Table has a higher weight capacity than all of the other camping tables mentioned"
    - question: "How much does TrailWalker Hiking Shoes cost? "
      truth: "$110"
    - question: "What is the proper care for trailwalker hiking shoes? "
      truth: "After each use, remove any dirt or debris by brushing or wiping the shoes with a damp cloth."
    - question: "What brand is for TrailMaster tent? "
      truth: "OutdoorLiving"
    - question: "How do I carry the TrailMaster tent around? "
      truth: " Carry bag included for convenient storage and transportation"
    - question: "What is the floor area for Floor Area? "
      truth: "120 square feet"
    - question: "What is the material for TrailBlaze Hiking Pants"
      truth: "Made of high-quality nylon fabric"
    - question: "What color does TrailBlaze Hiking Pants come in"
      truth: "Khaki"
    - question: "Cant he warrenty for TrailBlaze pants be transfered? "
      truth: "he warranty is non-transferable and applies only to the original purchaser of the TrailBlaze Hiking Pants. It is valid only when the product is purchased from an authorized retailer."
    - question: "How long are the TrailBlaze pants under warrenty for? "
      truth: " The TrailBlaze Hiking Pants are backed by a 1-year limited warranty from the date of purchase."
    - question: "What is the material for PowerBurner Camping Stove? "
      truth: "Stainless Steel"
    - question: "France is in Europe"
      truth: "Sorry, I can only truth questions related to outdoor/camping gear and equipment"

  steps:
  - name: Predict the answer w/ `ai chat`
    command: ai chat
    arguments:
      question: ${{ matrix.question }}
      assistant-id: ${{ matrix.assistant-id }}
      output-chat-history: ${{ matrix.predict-answer-output-chat-history-file }}
      output-answer: ${{ matrix.predict-answer-output-answer-file }}
  - name: Check the answer against the truth
    command: ai chat
    arguments:
      assistant-id: '@none'
      system-prompt: You are a helpful assistant.
      question: ${{ matrix.eval-answer-prompt }}
      output-chat-history: ${{ matrix.eval-answer-output-chat-history-file }}
      output-answer: ${{ matrix.eval-answer-output-answer-file }}
- area: post-evals
  steps:
  - name: Post-evaluation
    command: ai chat --built-in-functions
    arguments:
      system-prompt: You are a helpful assistant.
      question: ${{ matrix.eval-answer-average-answer-prompt }}
      output-answer: ${{ matrix.eval-answer-average-answer-file }}
