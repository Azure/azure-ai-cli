workingDirectory: aistudio-copilot-sample
tests:

- area: setup
  tags: [before]
  tests:
  - name: clone the aistudio-copilot-sample repo
    bash: |
      if [ ! -d ".git/" ]; then
        echo "Cloning the aistudio-copilot-sample repo..."
        git clone https://github.com/Azure/aistudio-copilot-sample.git  --depth 1 --no-single-branch .
      else
        echo "Pulling the latest changes from the aistudio-copilot-sample repo..."
        git pull
      fi
      ls -la
      git log -n 1

  - name: check cli is installed
    command: ai
    expect: |
      ^AI - Azure AI CLI, Version [01]\.0\..*\r?$\n
      ^Copyright \(c\) 2024 Microsoft Corporation\. All Rights Reserved\.\r?$\n
    tag: skip

  - name: check az is installed and we're logged in
    bash: |
      az account show
    expect: |
      "id": "[-a-z0-9-]{36}",
    tag: skip

  - name: ai init openai deployments
    command: ai init openai deployments
    arguments:
      subscription: e72e5254-f265-4e95-9bd2-9ee8e7329051
      name: robch-oai-eastus2
      chat-deployment-name: gpt-4-32k-0613
      embeddings-deployment-name: text-embedding-ada-002-2
      evaluation-deployment-name: gpt-4-32k-0613
      interactive: false

  - name: check ai config for chat
    bash: |
      ai config chat @key
      ai config chat @endpoint
      ai config chat @deployment
      ai config chat @model
    expect: |
      (?# ---------- CHAT KEY)
      chat.key \(found at '.*[/\\]\.ai[/\\]data'\)
      [a-z0-9]{32}

      (?# ---------- CHAT ENDPOINT)
      chat.endpoint \(found at '.*[/\\]\.ai[/\\]data'\)
      https://.*openai.azure.com/

      (?# ---------- CHAT DEPLOYMENT)
      chat.deployment \(found at '.*[/\\]\.ai[/\\]data'\)

      (?# ---------- CHAT MODEL)
      chat.model \(found at '.*[/\\]\.ai[/\\]data'\)
      (gpt-4|gpt-35)
    tag: skip

- name: test ai search index update
  command: ai search index update --files "./data/3-product-info/*.md" --index-name "product-info"
  expect: |
    Updating search index 'product-info' ...
    Updating search index 'product-info' ... Done!
    search.index.name \(saved at .*[/\\]\.ai[/\\]data[/\\]?\)
      product-info
  tag: skip

- name: check search index name
  command: ai config @search.index.name
  expect: product-info
  tag: skip

- name: test ai dev new .env
  command: ai dev new .env
  expect: |
    .env \(saved at .*aistudio-copilot-sample.*\)
      AZURE_AI_SEARCH_ENDPOINT = 
      AZURE_AI_SEARCH_INDEX_NAME = 
      AZURE_AI_SEARCH_KEY = 
      AZURE_AI_SPEECH_ENDPOINT = 
      AZURE_AI_SPEECH_KEY = 
      AZURE_AI_SPEECH_REGION = 
      AZURE_COGNITIVE_SEARCH_KEY = 
      AZURE_COGNITIVE_SEARCH_TARGET = 
      AZURE_OPENAI_API_VERSION = 
      AZURE_OPENAI_CHAT_DEPLOYMENT = 
      AZURE_OPENAI_CHAT_MODEL = 
      AZURE_OPENAI_EMBEDDING_DEPLOYMENT = 
      AZURE_OPENAI_EMBEDDING_MODEL = 
      AZURE_OPENAI_ENDPOINT = 
      AZURE_OPENAI_EVALUATION_DEPLOYMENT = 
      AZURE_OPENAI_EVALUATION_MODEL = 
      AZURE_OPENAI_KEY = 
  tag: skip

- name: test ai chat --interactive
  command: ai chat --interactive
  input: |
    which tent is the most waterproof?
  tag: skip
