<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">

  <Product Id="*" Name="Azure AI CLI" Language="1033" Version="$(var.productVersion)" Manufacturer="Microsoft" UpgradeCode="F1CDBA9C-E353-4039-9A20-059A1E587E73">
    <Package InstallerVersion="500" Compressed="yes" InstallScope="perMachine" Platform="$(var.targetPlatform)" />
    <!--
    To prevent problems with bundle upgrades, use MajorUpgrade element here and ProductSearch in the bundle wxs.
    -->
    <MajorUpgrade AllowDowngrades="no" DowngradeErrorMessage="A newer version is already installed." />

    <!--
    Below can be used to control upgrades on a single MSI-only (non-bundle) installation.
    -->
    <!--
    <Upgrade Id="F1CDBA9C-E353-4039-9A20-059A1E587E73">
      <UpgradeVersion OnlyDetect="yes" Property="SELFFOUND"
        Minimum="$(var.productVersion)" IncludeMinimum="yes"
        Maximum="$(var.productVersion)" IncludeMaximum="yes" />
      <UpgradeVersion OnlyDetect="yes" Property="NEWERFOUND"
        Minimum="$(var.productVersion)" IncludeMinimum="no" />
      <UpgradeVersion OnlyDetect="no" Property="PREVIOUSFOUND"
        Minimum="1.0.0" IncludeMinimum="yes"
        Maximum="$(var.productVersion)" IncludeMaximum="no" />
    </Upgrade>

    <CustomAction Id="AlreadyUpdated" Error="This version is already installed." />
    <CustomAction Id="NoDowngrade" Error="A newer version is already installed." />
    -->

    <Media Id="1" Cabinet="media1.cab" EmbedCab="yes" />

    <Directory Id="TARGETDIR" Name="SourceDir">
      <Directory Id="ProgramFilesFolder">
        <Directory Id="INSTALLFOLDER" Name="Azure AI CLI" />
      </Directory>
    </Directory>

    <?define basename="Azure.AI.CLI.$(var.packageVersion)" ?>

    <!-- Create a unique temp folder. -->
    <SetProperty Id="RunMakeTempDirCmd"
                 Value="&quot;cmd.exe&quot; /c mkdir &quot;[%TEMP]\$(var.basename)&quot;"
                 Sequence="execute"
                 Before="LaunchConditions" />
    <CustomAction Id="RunMakeTempDirCmd"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <!-- Download the AI CLI package from blob storage. -->
    <SetProperty Id="RunDownloadCmd"
                 Value="&quot;curl.exe&quot; --output &quot;[%TEMP]\$(var.basename)\$(var.basename).nupkg&quot; --url $(var.packageUrl)"
                 Sequence="execute"
                 Before="LaunchConditions" />
    <CustomAction Id="RunDownloadCmd"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <!-- Install the AI CLI package as a .NET tool. -->
    <SetProperty Id="RunInstallCmd"
                 Value="&quot;dotnet.exe&quot; tool update --global --add-source &quot;[%TEMP]\$(var.basename)&quot; Azure.AI.CLI --version $(var.packageVersion)"
                 Sequence="execute"
                 Before="LaunchConditions" />
    <CustomAction Id="RunInstallCmd"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="check" />

    <!-- Uninstall the AI CLI .NET tool. -->
    <SetProperty Id="RunUninstallCmd"
                 Value="&quot;dotnet.exe&quot; tool uninstall --global Azure.AI.CLI"
                 Sequence="execute"
                 Before="LaunchConditions" />
    <CustomAction Id="RunUninstallCmd"
                  BinaryKey="WixCA"
                  DllEntry="WixQuietExec"
                  Execute="deferred"
                  Impersonate="no"
                  Return="ignore" />

    <ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="LicenseDoc" Guid="9343B67B-61D6-4F7C-9B82-E6CA30C30038">
        <File Id="License.rtf" Source="$(sys.SOURCEFILEDIR)\CLI_License.rtf" KeyPath="yes" />
      </Component>
    </ComponentGroup>

    <InstallExecuteSequence>
      <!--
      <Custom Action="AlreadyUpdated" After="FindRelatedProducts">SELFFOUND</Custom>
      <Custom Action="NoDowngrade" After="FindRelatedProducts">NEWERFOUND</Custom>
      -->
      <Custom Action="RunMakeTempDirCmd" Before="InstallFinalize">NOT Installed OR REINSTALL OR UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="RunDownloadCmd" After="RunMakeTempDirCmd">NOT Installed OR REINSTALL OR UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="RunInstallCmd" After="RunDownloadCmd">NOT Installed OR REINSTALL OR UPGRADINGPRODUCTCODE</Custom>
      <Custom Action="RunUninstallCmd" Before="RemoveFiles">Installed AND NOT REINSTALL AND NOT UPGRADINGPRODUCTCODE</Custom>
    </InstallExecuteSequence>

    <Feature Id="MainFeature" Title="Main Feature" Level="1">
      <ComponentGroupRef Id="ProductComponents" />
    </Feature>

    <WixVariable Id="WixUILicenseRtf" Value="$(sys.SOURCEFILEDIR)\CLI_License.rtf" />
    <UIRef Id="WixUI_Minimal" />

  </Product>
</Wix>
