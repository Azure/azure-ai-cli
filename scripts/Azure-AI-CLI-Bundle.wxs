<?xml version="1.0" encoding="UTF-8"?>
<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi"
     xmlns:bal="http://schemas.microsoft.com/wix/BalExtension"
     xmlns:util="http://schemas.microsoft.com/wix/UtilExtension">

    <Bundle Name="Azure AI CLI"
            Version="$(var.version)"
            Manufacturer="Microsoft"
            UpgradeCode="436172626F6E20697320636F6F6C2123"
            DisableModify="yes">

        <BootstrapperApplicationRef Id="WixStandardBootstrapperApplication.RtfLicense">
            <bal:WixStandardBootstrapperApplication LicenseFile="CLI_License.rtf" SuppressOptionsUI="yes" SuppressRepair="yes"/>
        </BootstrapperApplicationRef>

        <!-- Check the version of existing Azure AI CLI .msi installation -->
        <util:ProductSearch Variable="AlreadyInstalledVersion"
                            UpgradeCode="BDE6DEF4-9259-4BD5-9BC8-FDA1660FF7AD"
                            Id="AlreadyInstalledVersionSearch"
                            Result="version"/>
        <!--
        Workaround for https://github.com/wixtoolset/issues/issues/3746 (note: WixBundleAction is 5 on Uninstall)
        https://stackoverflow.com/questions/26596354/upgrade-a-bootstrapper-bundle-if-the-same-version-is-detected
        -->
        <bal:Condition Message="The same or newer version of this product is already installed. Please uninstall the existing version first.">
        NOT WixBundleAction = 5 OR NOT AlreadyInstalledVersion &gt;= v$(var.version)
        </bal:Condition>

        <Chain>
            <!-- Dependencies -->
            <PackageGroupRef Id="DotNetSdk"/>
            <PackageGroupRef Id="AzureCLI"/>

            <MsiPackage Id="AzureAI_CLI" SourceFile="Azure-AI-CLI.msi" Vital="yes"/>
        </Chain>
    </Bundle>

    <Fragment>
        <!-- .NET SDK -->
        <util:DirectorySearch Id="DotNetDirectory"
                              Path="[ProgramFiles64Folder]dotnet\sdk\$(var.dotNetVersion)"
                              Result="exists"
                              Variable="DOTNET_SDK_INSTALLED"/>

        <PackageGroup Id="DotNetSdk">
            <ExePackage Id="DotNetSdk"
                        Name="dotnet-sdk-$(var.dotNetVersion)-win-$(var.platform).exe"
                        Cache="no"
                        Compressed="no"
                        DetectCondition="DOTNET_SDK_INSTALLED"
                        DownloadUrl="$(var.dotNetUrl)"
                        InstallCommand="/passive /norestart"
                        PerMachine="yes"
                        Permanent="yes"
                        Vital="yes">
                <RemotePayload Description=".NET SDK"
                               ProductName=".NET SDK"
                               Version="$(var.dotNetVersion).0"
                               Size="$(var.dotNetSize)"
                               Hash="$(var.dotNetSha1)"/>
            </ExePackage>
        </PackageGroup>

        <!-- Azure CLI -->
        <util:DirectorySearch Id="AzureCLIDirectory"
                              Path="[ProgramFiles64Folder]Microsoft SDKs\Azure\CLI2"
                              Result="exists"
                              Variable="AZURE_CLI_INSTALLED"/>

        <PackageGroup Id="AzureCLI">
            <!-- Workaround for RemotePayload not supported with MsiPackage -->
            <ExePackage Id="AzureCLI"
                        Name="InstallAzureCLI.cmd"
                        Compressed="yes"
                        DetectCondition="AZURE_CLI_INSTALLED"
                        SourceFile="InstallAzureCLI.cmd"
                        InstallCommand="$(var.azureCliVersion) $(var.platform)"
                        PerMachine="yes"
                        Permanent="yes"
                        Vital="yes"/>
        </PackageGroup>
    </Fragment>
</Wix>
