trigger:
  branches:
    include:
      - main
      - refs/tags/*
pr:
  - main

pool:
  name: SkymanUbuntu2004Hosted

stages:

- stage: SetupStage
  jobs:
  - job: SetupJob
    steps:
    - task: Bash@3
      name: Variables
      inputs:
        filePath: ./.azure/pipelines/scripts/set-variables.sh
        arguments: '0.0.0-dev2023.$(Build.BuildId)'
      displayName: 'Set up environment variables'

- stage: BuildStage
  dependsOn: SetupStage
  jobs:

    - job: Build
      variables:
        IsRelease: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.IsRelease']]
        AICLIVersion: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLIVersion']]
        AICLISemVerVersion: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLISemVerVersion']]
        AICLINuPkgFileName: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLINuPkgFileName']]
      steps:
      - task: DotNetCoreCLI@2
        displayName: Restore packages
        inputs:
          command: restore
          projects: 'src/ai/**/*.csproj'
      - task: DotNetCoreCLI@2
        displayName: Build
        inputs:
          command: build
          projects: 'src/ai/**/*.csproj'
          arguments: '--configuration Release -p:CLIAssemblyVersion=$(AICLISemVerVersion) -p:CLIAssemblyInformationalVersion=$(AICLIVersion)'
      - task: DotNetCoreCLI@2
        displayName: Pack
        inputs:
          command: custom
          custom: 'pack'
          projects: 'src/ai/ai-cli.csproj'
          arguments: '--configuration Release -p:CLIAssemblyVersion=$(AICLISemVerVersion) -p:CLIAssemblyInformationalVersion=$(AICLIVersion) -p:PackageVersion=$(AICLIVersion) -o "$(Build.ArtifactStagingDirectory)"'
      - task: UseDotNet@2
        displayName: 'Use .NET Core 2.1 (signing requirement)'
        inputs:
          packageType: 'sdk'
          version: '2.1.x'
      - template: sign-nuget.yaml
        parameters:
          displayName: 'Sign AI CLI NuGet package'
          folderPath: '$(Build.ArtifactStagingDirectory)'
          pattern: '$(AICLINuPkgFileName)'
      - task: Bash@3
        displayName: 'Create installation script'
        inputs:
          filePath: ./scripts/InstallAzureAICLIDeb-UpdateVersion.sh
          arguments: '$(AICLIVersion) $(Build.StagingDirectory)'
      - task: PublishPipelineArtifact@1
        displayName: Publish artifacts
        inputs:
          targetPath: '$(Build.StagingDirectory)'
          artifact: 'ai-cli-artifacts'

    - job: Publish
      dependsOn: [Build]
      variables:
        IsRelease: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.IsRelease']]
        AICLIVersion: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLIVersion']]
        AICLINuPkgFileName: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLINuPkgFileName']]
      condition: and(succeeded(), or(eq(variables['IsRelease'], 'true'), eq(variables['PublishDevBuild'], 'true')))
      steps:
      - task: DownloadPipelineArtifact@2
        displayName: Download artifacts
        inputs:
          artifact: 'ai-cli-artifacts'
          targetPath: '$(Build.ArtifactStagingDirectory)'
      - task: AzureCLI@2
        displayName: Upload NuGet package
        inputs:
          azureSubscription: 'Carbon Dropper (CSSpeechStorage Drop)'
          scriptType: 'bash'
          arguments: '$(Build.ArtifactStagingDirectory)/$(AICLINuPkgFileName) private/ai/$(AICLINuPkgFileName)'
          scriptPath: './.azure/pipelines/scripts/upload-file.sh'
      - task: AzureCLI@2
        displayName: Upload installation script
        inputs:
          azureSubscription: 'Carbon Dropper (CSSpeechStorage Drop)'
          scriptType: 'bash'
          arguments: '$(Build.ArtifactStagingDirectory)/InstallAzureAICLIDeb-$(AICLIVersion).sh private/ai/InstallAzureAICLIDeb-$(AICLIVersion).sh'
          scriptPath: './.azure/pipelines/scripts/upload-file.sh'
      - task: GithubRelease@1
        condition: and(succeeded(), eq(variables['IsRelease'], 'true'))
        displayName: Create GitHub release
        inputs:
          gitHubConnection: 'AzureGH'
          tagSource: gitTag
          title: 'Azure AI CLI $(AICLIVersion)'
          releaseNotesSource: inline
          addChangeLog: true
          releaseNoteInline: |
            Version $(AICLIVersion) of the Azure AI CLI.

    - job: DockerImages
      dependsOn: [Build, Publish]
      variables:
        IsRelease: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.IsRelease']]
        AICLIVersion: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLIVersion']]
        AICLINuPkgFileName: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLINuPkgFileName']]
      condition: and(succeeded(), or(eq(variables['IsRelease'], 'true'), eq(variables['PublishDevBuild'], 'true')))
      strategy:
        matrix:
          debian10:
            dockerfile: 'dockerfiles/debian10.Dockerfile'
            tags: |
              buster-$(AICLIVersion)
          debian11:
            dockerfile: 'dockerfiles/debian11.Dockerfile'
            tags: |
              bullseye-$(AICLIVersion)
          debian12:
            dockerfile: 'dockerfiles/debian12.Dockerfile'
            tags: |
              bookworm-$(AICLIVersion)
          ubuntu2004:
            dockerfile: 'dockerfiles/ubuntu2004.Dockerfile'
            tags: |
              focal-$(AICLIVersion)
          ubuntu2204:
            dockerfile: 'dockerfiles/ubuntu2204.Dockerfile'
            tags: |
              jammy-$(AICLIVersion)
      steps:
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          containerRegistry: 'acrbn-acr'
          command: 'login'
      - task: Docker@2
        displayName: Build ($(dockerfile) - $(AICLIVersion) - $(tags))
        inputs:
          command: 'build'
          containerRegistry: 'acrbn-acr'
          repository: 'azure-ai-cli'
          Dockerfile: $(dockerfile)
          arguments: '--build-arg AZURE_CLI_VERSION=$(AICLIVersion) --build-arg DOWNLOAD_SCRIPT=true'
          buildContext: '.'
          tags: |
            $(tags)
      - task: Docker@2
        displayName: Push ($(dockerfile) - $(tags))
        inputs:
          command: 'push'
          containerRegistry: 'acrbn-acr'
          repository: 'azure-ai-cli'
          tags: |
            $(tags)

    - job: TagLatest
      dependsOn: [Build, Publish, DockerImages]
      variables:
        IsRelease: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.IsRelease']]
        AICLIVersion: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLIVersion']]
      condition: and(succeeded(), eq(variables['IsRelease'], 'true'))
      steps:
      - task: Docker@2
        displayName: Login to ACR
        inputs:
          containerRegistry: 'acrbn-acr'
          command: 'login'
      - task: Bash@3
        displayName: Tag Latest
        inputs:
          targetType: 'inline'
          script: |
            docker pull acrbn.azurecr.io/azure-ai-cli:bookworm-$(AICLIVersion)
            docker tag acrbn.azurecr.io/azure-ai-cli:bookworm-$(AICLIVersion) acrbn.azurecr.io/azure-ai-cli:latest
            docker push acrbn.azurecr.io/azure-ai-cli:latest

- stage: ManualApproval
  dependsOn: [SetupStage, BuildStage]
  condition: and(succeeded(), or(eq(stageDependencies.SetupStage.outputs['SetupJob.Variables.IsRelease'], 'true'), eq(variables['PublishDevBuild'], 'true')))
  variables:
    AICLIVersion: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLIVersion']]
    AICLINuPkgFileName: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLINuPkgFileName']]
  jobs:

  - job: ManualApprovalSteps
    pool: server
    steps:
    - task: ManualValidation@0
      timeoutInMinutes: 5
      inputs:
        notifyUsers: |
          robch@microsoft.com
          brianem@microsoft.com
        instructions: Approve publish ai version publicly to NuGet.org
        onTimeout: reject

- stage: PublishPublic
  dependsOn: [SetupStage, BuildStage, ManualApproval]
  condition: and(succeeded(), or(eq(stageDependencies.SetupStage.outputs['SetupJob.Variables.IsRelease'], 'true'), eq(variables['PublishDevBuild'], 'true')))
  variables:
    AICLIVersion: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLIVersion']]
    AICLINuPkgFileName: $[ stageDependencies.SetupStage.SetupJob.outputs['Variables.AICLINuPkgFileName']]
  jobs:

  - job: PublishToNuGet
    steps:
    - task: DownloadPipelineArtifact@2
      displayName: Download artifacts
      inputs:
        artifact: 'ai-cli-artifacts'
        targetPath: '$(Build.ArtifactStagingDirectory)'
    - task: NuGetCommand@2
      displayName: 'Publish nuget package to NuGet.org'
      inputs:
        command: push
        nuGetFeedType: external
        publishFeedCredentials: 'AzureAICLI(NugetPublishing)'
        packagesToPush: '$(Build.ArtifactStagingDirectory)/$(AICLINuPkgFileName)'
