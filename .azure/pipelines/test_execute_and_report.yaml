parameters:
  test_adapter_name: Azure.AI.CLI.TestAdapter
  TestFilter: 'TestCategory!=SkipOnVSTS'
  envToSet: ''
steps:
# -----------------------------------------------------------------------------
# Run the tests
# -----------------------------------------------------------------------------
- task: AzureCLI@2
  displayName: Run ai-cli tests
  continueOnError: true
  inputs:
    azureSubscription: 'AI_CLI_TestAdapter'
    scriptType: 'bash'
    scriptLocation: 'inlineScript'
    inlineScript: |
      az --version
      az account show

      cd $(TestResultsPath)
      IFS=';' read -ra ENV_VARS <<< "${{ parameters.envToSet }}"  
      for env_var in "${ENV_VARS[@]}"; do  
        echo "Setting $env_var"
        export "$env_var"  
      done  
      
      echo
      echo "Running Docker containers"
      docker ps
      echo
      echo "Current Environment Variables"
      env
      echo
      
      echo dotnet test --logger trx --results-directory "$(Agent.TempDirectory)" --logger:"trx;LogFileName=$(TestRunTrxFileName)-${{ parameters.test_adapter_name }}.trx" --logger:"console;verbosity=normal" --filter "${{ parameters.TestFilter }}" "$(LocalBinOutputPath)/$(BuildConfiguration)/net8.0/${{ parameters.test_adapter_name }}.dll"   
      dotnet test --logger trx --results-directory "$(Agent.TempDirectory)" --logger:"trx;LogFileName=$(TestRunTrxFileName)-${{ parameters.test_adapter_name }}.trx" --logger:"console;verbosity=normal" --filter "${{ parameters.TestFilter }}" "$(LocalBinOutputPath)/$(BuildConfiguration)/net8.0/${{ parameters.test_adapter_name }}.dll"   

# -----------------------------------------------------------------------------
# Archive and publish the test run backup artifact
# -----------------------------------------------------------------------------
- task: ArchiveFiles@2
  displayName: Archive ai-cli-test run backup artifact (build/bin)
  continueOnError: true
  inputs:
    rootFolderOrFile: '$(LocalBinOutputPath)'
    includeRootFolder: false
    archiveFile: '$(TestBackupArtifactFile)'
    replaceExistingArchive: false

- task: ArchiveFiles@2
  displayName: Archive ai-cli-test run backup artifact (testresults)
  continueOnError: true
  inputs:
    rootFolderOrFile: '$(TestResultsPath)'
    includeRootFolder: false
    archiveFile: '$(TestBackupArtifactFile)'
    replaceExistingArchive: false

- task: PublishBuildArtifacts@1
  displayName: Publish ai-cli-test run backup artifact
  continueOnError: true
  retryCountOnTaskFailure: 5
  inputs:
    parallel: true
    pathToPublish: '$(TestBackupArtifactFile)'
    artifactName: TestRunBackup

# -----------------------------------------------------------------------------
# Publish the test results
# -----------------------------------------------------------------------------
- task: PublishTestResults@2
  displayName: Publish ai-cli test results
  condition: succeededOrFailed()
  inputs:
    testRunner: VSTest
    testResultsFiles: '$(TestRunTrxFileName)-${{ parameters.test_adapter_name }}.trx' 
    testRunTitle: '$(TestRunTitle)'
    failTaskOnFailedTests: true